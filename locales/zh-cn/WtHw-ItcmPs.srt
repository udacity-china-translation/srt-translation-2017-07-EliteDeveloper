1
00:00:00,550 --> 00:00:02,639
目前为止 我们成功让小部件

2
00:00:02,640 --> 00:00:05,410
启动了一项在后台运行的 Intent 服务

3
00:00:05,410 --> 00:00:08,679
并更新数据库来给所有植物浇水

4
00:00:08,679 --> 00:00:11,169
但是目前 此服务不会向小部件

5
00:00:11,169 --> 00:00:13,493
发送更新或响应

6
00:00:13,493 --> 00:00:15,910
现在 假设我们希望小部件显示

7
00:00:15,910 --> 00:00:18,929
最需要关注的植物 或最接近死亡的植物

8
00:00:18,929 --> 00:00:21,233
来看看如何做到

9
00:00:21,234 --> 00:00:22,900
要这样做 我们需要

10
00:00:22,899 --> 00:00:25,273
在浇水服务中创建一个新的操作 来运行数据库

11
00:00:25,274 --> 00:00:28,839
查询 然后获取接近死亡的植物

12
00:00:28,839 --> 00:00:32,689
然后更新小部件图像以显示该植物

13
00:00:32,689 --> 00:00:34,329
向服务添加更新操作

14
00:00:34,329 --> 00:00:35,829
和我们在之前练习中

15
00:00:35,829 --> 00:00:37,509
添加给植物浇水的操作

16
00:00:37,509 --> 00:00:39,429
非常相似

17
00:00:39,429 --> 00:00:42,340
首先 我们需要添加一个新的字符串常量来定义

18
00:00:42,340 --> 00:00:43,910
新的操作

19
00:00:43,909 --> 00:00:49,569
我在这里使用 action_update_plant_widgets

20
00:00:49,570 --> 00:00:52,179
接下来 创建另一个 startAction 方法

21
00:00:52,179 --> 00:00:55,840
用于明确创建和启动 Intent

22
00:00:55,840 --> 00:00:58,120
而且我们需要在 onHandleIntent 中

23
00:00:58,119 --> 00:01:02,289
添加一个 if 语句 来处理这个新的操作类型

24
00:01:02,289 --> 00:01:06,340
要这样做 我们调用一个叫作 handleActionUpdatePlantWidgets

25
00:01:06,340 --> 00:01:08,000
的新方法

26
00:01:08,000 --> 00:01:11,560
然后在 handleActionUpdatePlantWidgets 内

27
00:01:11,560 --> 00:01:14,469
运行一项查询 按 COLUMN_LAST_WATERED_TIME

28
00:01:14,469 --> 00:01:17,859
对植物排序 以获取最接近死亡的植物

29
00:01:17,859 --> 00:01:20,859
然后重新运行顶行

30
00:01:20,859 --> 00:01:23,379
我们需要提取所有植物信息

31
00:01:23,379 --> 00:01:26,769
并使用规划工具方法 即这里这个

32
00:01:26,769 --> 00:01:30,519
getPlantImageRes 来获取要在小部件中

33
00:01:30,519 --> 00:01:32,689
显示的适当图像资源

34
00:01:32,689 --> 00:01:35,649
现在如果我们打开 PlantWidgetProvider

35
00:01:35,650 --> 00:01:38,260
你会注意到 updatePlantWidgets 方法

36
00:01:38,260 --> 00:01:41,060
实际上是一个静态方法

37
00:01:41,060 --> 00:01:43,540
这意味着我们可以在任何地方调用它

38
00:01:43,540 --> 00:01:46,390
并向它传入我们所需的任何参数

39
00:01:46,390 --> 00:01:50,260
在我们的例子中 我们需要传入一个整数参数

40
00:01:50,260 --> 00:01:54,130
叫做 imgRes 它将保存在更新小部件时

41
00:01:54,129 --> 00:01:57,310
要在其中显示的图像资源的标识符

42
00:01:57,310 --> 00:02:01,450
我们使用 updateAppWidget 方法更新小部件

43
00:02:01,450 --> 00:02:05,829
现在在这个方法内 我们调用 setImageViewResource

44
00:02:05,829 --> 00:02:08,530
这会帮我们将青草图替换为

45
00:02:08,530 --> 00:02:10,788
需要传入的图像

46
00:02:10,788 --> 00:02:12,219
现在回到我们的 IntentService

47
00:02:12,219 --> 00:02:16,330
我们传入正确的图像资源 以及

48
00:02:16,330 --> 00:02:18,940
appWidgetManager 和需要

49
00:02:18,939 --> 00:02:22,939
从 appWidgetManager 提取的 appWidgetID

50
00:02:22,939 --> 00:02:25,689
现在要确保小部件始终处于最新状态

51
00:02:25,689 --> 00:02:28,000
我们需要在每次数据库发生变化时

52
00:02:28,000 --> 00:02:29,620
启动此新操作

53
00:02:29,620 --> 00:02:36,375
基本上也就是说我们每次添加新植物、删除植物

54
00:02:36,375 --> 00:02:39,280
或给植物浇水时

